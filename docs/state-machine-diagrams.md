# J-Flash 컴포넌트 상태 머신 다이어그램

이 문서는 J-Flash 앱의 주요 컴포넌트별 상태 머신(State Machine)을 설명합니다.

---

## 1. Review Page (복습 페이지)

### 1.1 세션 상태 (SessionState)

```
┌─────────────┐
│   INITIAL   │
└──────┬──────┘
       │ mount
       ▼
┌─────────────┐
│   loading   │ ← loadCards() 호출
└──────┬──────┘
       │ cards 로드 완료
       ▼
┌─────────────┐
│    ready    │ ← 복습 대기 상태
└──────┬──────┘
       │ startSession()
       ▼
┌─────────────┐
│  studying   │ ← 플래시카드 학습 중
└──────┬──────┘
       │ 마지막 카드 완료
       ▼
┌─────────────┐
│  complete   │ ← 세션 완료
└──────┬──────┘
       │ restartSession()
       └──────────────────────────────────┐
                                          ▼
                                   loading (다시 시작)
```

**상태 정의:**
| 상태 | 설명 | 진입 조건 | 가능한 액션 |
|------|------|----------|-------------|
| `loading` | 카드 로딩 중 | 초기 mount, restartSession | 로딩 스피너 표시 |
| `ready` | 복습 준비 완료 | 카드 로드 성공 | 통계 확인, 모드 선택, startSession |
| `studying` | 학습 진행 중 | startSession() | 카드 flip, 정답/오답 |
| `complete` | 세션 완료 | 마지막 카드 답변 | 결과 확인, restartSession |

---

### 1.2 카드 상태 (Card Flip State)

```
           ┌─────────────┐
           │  isFlipped  │
           │   = false   │ (앞면)
           └──────┬──────┘
                  │ flipCard() / Space 키
                  ▼
           ┌─────────────┐
           │  isFlipped  │
           │   = true    │ (뒷면)
           └──────┬──────┘
                  │ handleAnswer(known)
                  │
        ┌─────────┴─────────┐
        ▼                   ▼
  ┌───────────┐       ┌───────────┐
  │  correct  │       │ incorrect │
  │   (+1)    │       │   (+1)    │
  └─────┬─────┘       └─────┬─────┘
        │                   │
        └─────────┬─────────┘
                  ▼
           다음 카드로 이동
           (isFlipped = false)
```

---

### 1.3 복습 모드 (ReviewMode)

```
                    ┌─────────────┐
                    │   normal    │ ← 기본값
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
  ┌───────────┐     ┌───────────┐     ┌───────────┐
  │  reverse  │     │ listening │     │   cloze   │
  │ 의미→일어  │     │  TTS→단어  │     │ 빈칸 채우기 │
  └───────────┘     └───────────┘     └───────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           ▼
                    ┌─────────────┐
                    │  sentence   │ ← URL ?mode=sentence
                    │  (문장 모드) │
                    └─────────────┘
```

**모드별 동작:**
| 모드 | 앞면 | 뒷면 | 특수 동작 |
|------|------|------|----------|
| `normal` | 한자 | 읽기 + 의미 + 예문 | - |
| `reverse` | 의미 + 품사 | 한자 + 읽기 | - |
| `listening` | 🔊 버튼 | 한자 + 의미 | TTS 자동 재생 |
| `cloze` | ___가 있는 예문 | 정답 단어 + 예문 | 예문 필수 |
| `sentence` | 문장 전체 | 읽기 + 의미 | pos="文" 필터 |

---

## 2. Vocab Page (단어장 페이지)

### 2.1 데이터 소스 상태 (DataSource)

```
┌─────────────────────────────────────────────────┐
│                  DataSource                      │
│                                                  │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│   │  active  │←→│ mastered │←→│   all    │     │
│   │ 학습 중   │  │  마스터   │  │   전체   │     │
│   └──────────┘  └──────────┘  └──────────┘     │
│         ↓             ↓             ↓          │
│   words.json    mastered/     전체 합침         │
│   sentences.json  *.json                        │
└─────────────────────────────────────────────────┘
```

---

### 2.2 필터 타입 상태 (FilterType)

```
┌─────────────────────────────────────┐
│            FilterType               │
│                                     │
│   ┌───────┐  ┌───────┐  ┌────────┐ │
│   │  all  │←→│ words │←→│sentences│ │
│   │ 전체  │  │ 단어만 │  │ 문장만 │ │
│   └───┬───┘  └───┬───┘  └────┬───┘ │
│       │          │           │      │
│       ▼          ▼           ▼      │
│   vocabList  pos≠"文"    pos="文"   │
└─────────────────────────────────────┘
```

---

### 2.3 정렬 상태 (SortOption)

```
┌────────────────────────────────────────────────────────────┐
│                        SortOption                           │
│                                                             │
│  ┌──────────┐                                              │
│  │ priority │ ← 기본값 (학습 우선순위)                       │
│  └────┬─────┘                                              │
│       │                                                     │
│  ┌────┼────┬─────────┬──────────┬─────────┐               │
│  ▼    ▼    ▼         ▼          ▼         ▼               │
│ ┌───┐ ┌───┐ ┌────────┐ ┌────────┐ ┌──────┐               │
│ │new│ │lrn│ │mastered│ │ recent │ │prior.│               │
│ │   │ │   │ │        │ │        │ │      │               │
│ └───┘ └───┘ └────────┘ └────────┘ └──────┘               │
│                                                             │
│ 점수 계산 (priority):                                       │
│ - 새 단어: 0점 (최우선)                                     │
│ - ease_factor 낮을수록: 어려운 단어 우선                     │
│ - reps 낮을수록: 덜 학습된 단어 우선                         │
└────────────────────────────────────────────────────────────┘
```

---

### 2.4 로딩 상태

```
┌─────────────┐
│   INITIAL   │
└──────┬──────┘
       │ mount / dataSource 변경
       ▼
┌─────────────┐
│   loading   │ ← fetchVocab()
│  = true     │
└──────┬──────┘
       │
    ┌──┴──┐
    ▼     ▼
┌──────┐ ┌───────┐
│ 성공 │ │  에러  │
│      │ │       │
└──┬───┘ └───┬───┘
   │         │
   ▼         ▼
loading    error 표시
= false
```

---

## 3. SRS 상태 (Spaced Repetition System)

### 3.1 SM-2 알고리즘 상태

```
┌─────────────────────────────────────────────────────────────┐
│                    SRS State Machine                         │
│                                                              │
│                  ┌───────────────┐                          │
│                  │   NEW WORD    │ ← 초기 상태               │
│                  │   reps = 0    │                          │
│                  │   interval=1  │                          │
│                  │   ease=2.5    │                          │
│                  └───────┬───────┘                          │
│                          │                                   │
│           ┌──────────────┼──────────────┐                   │
│           ▼ (오답)       ▼ (정답)                           │
│    ┌──────────────┐  ┌──────────────┐                       │
│    │    RESET     │  │   LEARNING   │                       │
│    │   reps = 0   │  │   reps = 1   │                       │
│    │  interval=1  │  │  interval=1  │                       │
│    │  ease -= 0.2 │  │  ease 조정    │                       │
│    └──────┬───────┘  └──────┬───────┘                       │
│           │                  │ (정답)                        │
│           │                  ▼                              │
│           │          ┌──────────────┐                       │
│           │          │   LEARNING   │                       │
│           │          │   reps = 2   │                       │
│           │          │  interval=3  │                       │
│           │          └──────┬───────┘                       │
│           │                  │ (정답)                        │
│           │                  ▼                              │
│           │          ┌──────────────┐                       │
│           │          │   LEARNED    │                       │
│           │          │  reps >= 3   │                       │
│           │          │  interval    │                       │
│           │          │  *= ease     │                       │
│           │          └──────┬───────┘                       │
│           │                  │ (reps >= 5)                   │
│           │                  ▼                              │
│           │          ┌──────────────┐                       │
│           └─────────→│   MASTERED   │                       │
│             (오답)   │  reps >= 5   │                       │
│                      │ 장기 기억    │                       │
│                      └──────────────┘                       │
└─────────────────────────────────────────────────────────────┘
```

**간격 계산 공식:**
```
if (quality < 2) {      // 오답
    reps = 0
    interval = 1
    ease_factor = max(1.3, ease - 0.2)
} else {                // 정답
    reps++
    if (reps == 1) interval = 1
    else if (reps == 2) interval = 3
    else interval = round(interval × ease_factor)

    ease_factor = max(1.3, ease + (0.1 - (4-q)×(0.08 + (4-q)×0.02)))
}
next_review = today + interval (days)
```

**마스터 단어 복습 간격 예시:**
| reps | interval | ease_factor | next_review |
|------|----------|-------------|-------------|
| 5 | 8일 | 2.5 | +8일 |
| 6 | 20일 | 2.5 | +20일 |
| 7 | 50일 | 2.5 | +50일 |
| 8 | 125일 | 2.5 | +125일 |

---

## 4. Stats Page (통계 페이지)

### 4.1 로딩 상태

```
┌─────────────┐
│   mount     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   loading   │ ← loadAllStats()
│   = true    │
└──────┬──────┘
       │ Promise.all([words, sentences, mastered])
       ▼
┌─────────────┐
│   loaded    │
│  loading    │
│   = false   │
└─────────────┘
       │
       ▼
  ┌────────────────────────────────────────┐
  │ 통계 계산:                              │
  │ - JLPT 레벨별 분포                      │
  │ - 품사별 분포                           │
  │ - SRS 단계별 분포                       │
  │ - 학습 진행률                           │
  └────────────────────────────────────────┘
```

---

## 5. 전체 앱 네비게이션 흐름

```
┌────────────────────────────────────────────────────────────────┐
│                       J-Flash App Flow                          │
│                                                                 │
│                      ┌───────────┐                             │
│                      │   Home    │                             │
│                      │   (/)     │                             │
│                      └─────┬─────┘                             │
│                            │                                    │
│     ┌──────────┬──────────┼──────────┬──────────┬─────────┐   │
│     ▼          ▼          ▼          ▼          ▼         ▼   │
│ ┌───────┐ ┌─────────┐ ┌───────┐ ┌───────┐ ┌──────┐ ┌──────┐ │
│ │Review │ │Sentence │ │ Vocab │ │Grammar│ │Stats │ │ Data │ │
│ │/review│ │Review   │ │/vocab │ │/grammar│ │/stats│ │/data │ │
│ └───┬───┘ └────┬────┘ └───────┘ └───────┘ └──────┘ └──────┘ │
│     │          │                                              │
│     └──────────┤                                              │
│                ▼                                              │
│         ┌───────────┐                                         │
│         │ Studying  │ ← SessionState = "studying"             │
│         │ Flashcard │                                         │
│         └─────┬─────┘                                         │
│               │                                               │
│               ▼                                               │
│         ┌───────────┐                                         │
│         │ Complete  │ ← SessionState = "complete"             │
│         │  Results  │                                         │
│         └───────────┘                                         │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 6. 데이터 흐름 (Data Flow)

```
┌────────────────────────────────────────────────────────────────┐
│                       Data Flow Diagram                         │
│                                                                 │
│  ┌──────────────┐                                              │
│  │ Static JSON  │ ← /data/*.json                               │
│  │   Files      │                                              │
│  └──────┬───────┘                                              │
│         │ fetch()                                               │
│         ▼                                                       │
│  ┌──────────────┐        ┌──────────────┐                      │
│  │ static-data  │───────→│  Components  │                      │
│  │    .ts       │        │  (useState)  │                      │
│  └──────┬───────┘        └──────────────┘                      │
│         │                                                       │
│         │ getSRSStates() / saveSRSState()                      │
│         ▼                                                       │
│  ┌──────────────┐                                              │
│  │ localStorage │ ← jflash_srs_state                           │
│  │  (Browser)   │                                              │
│  └──────┬───────┘                                              │
│         │ syncWithCloud() (optional)                           │
│         ▼                                                       │
│  ┌──────────────┐                                              │
│  │  Supabase    │ ← Cloud backup                               │
│  │  (Optional)  │                                              │
│  └──────────────┘                                              │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## 요약

J-Flash 앱의 핵심 상태 머신:

1. **Review SessionState**: `loading` → `ready` → `studying` → `complete`
2. **Card Flip**: `front` ↔ `back` (정답/오답 후 다음 카드)
3. **ReviewMode**: `normal` | `reverse` | `listening` | `cloze` | `sentence`
4. **DataSource**: `active` | `mastered` | `all`
5. **FilterType**: `all` | `words` | `sentences`
6. **SortOption**: `priority` | `new` | `learning` | `mastered` | `recent`
7. **SRS State**: `NEW` → `LEARNING` → `LEARNED` → `MASTERED`

각 상태는 독립적으로 관리되며, React의 `useState` 훅을 통해 구현됩니다.
